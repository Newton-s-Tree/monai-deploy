# MONAI Deploy Helm Charts


## Prerequisites

### Install Tools

```bash
# Install kubernetes tools
sudo apt-get install -y -q kubelet kubectl kubeadm
sudo apt-mark hold kubelet kubeadm kubectl

# Install Helm
curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
```

### Install Kubernetes
Select one of the following Kubernetes distribution:
- [k3s](https://k3s.io/) [[Requirements](https://docs.k3s.io/installation/requirements)]
  ```bash
  curl -sfL https://get.k3s.io | sh -s - --flannel-backend host-gw --service-node-port-range 104-32767 --flannel-external-ip

  # Copy default configuration
  mkdir -p $HOME/.kube
  sudo cp -i /etc/rancher/k3s/k3s.yaml $HOME/.kube/config
  sudo chown $(id -u):$(id -g) $HOME/.kube/config
  ```

- [K8s](https://kubernetes.io/)
  For detail installation instructions with GPU support, see [cloud-native-stack](https://github.com/NVIDIA/cloud-native-stack/tree/master/install-guides).

  ```bash
  kubeadm init --pod-network-cidr=192.168.0.0/16
  # Copy default configuration
  mkdir -p $HOME/.kube
  sudo cp -i /etc/rancher/k3s/k3s.yaml $HOME/.kube/config
  sudo chown $(id -u):$(id -g) $HOME/.kube/config

  kubectl taint nodes --all node-role.kubernetes.io/control-plane-
  ```

  Note: in order to use the default DIMSE port 104, you must update `/etc/kubernetes/manifests/kube-apiserver.yaml`:

  ```bash
  sudo nano /etc/kubernetes/manifests/kube-apiserver.yaml  
  ```

  Insert, `--service-node-port-range=104-32767` under `spec.containers.command`.

## Install MONAI Deploy

### Build & download dependencies

```bash
helm dependency build
```

If you are reinstalling, run the following to remove existing `local-path-provisioner` Storage Class:

```bash
kubectl delete StorageClass local-path
```

### Install MONAI Deploy:

```bash
helm upgrade -i monai-deploy .
```

Upon successfully installation, optinally follow the on screen instructions to initialize Informatics Gateway & Orthanc.

### Uninstall MONAI Deploy:
```
helm uninstall monai-deploy
```


### Advanced Configuration

Most of the configurations may be found in the following files:

- `values.yaml`: contains container image repo, application secrets, ports, etc...
- `files/informatics-gateway.json`: Informatics Gateway specific configurations...
- `files/workflow-manager.json`: Workflow Manager specific configurations...
- `files/task-manager.json`: Task Manager specific configurations...
- `files/orthanc.json`: Orthanc specific configurations...

## Uninstall

### Uninstall Kubernetes

- [k3s](https://k3s.io/)
  ```bash
  kubectl delete StorageClass local-path
  /usr/local/bin/k3s-uninstall.sh
  ```

- [K8s](https://kubernetes.io/)
  ```bash
  kubectl delete StorageClass local-path
  sudo kubeadm reset
  ```

### Uninstall Tools

```bash
sudo apt-get purge -y kubeadm kubectl kubelet kubernetes-cni kube* helm
sudo apt-get autoremove   -y
sudo rm -rf ~/.kube
```